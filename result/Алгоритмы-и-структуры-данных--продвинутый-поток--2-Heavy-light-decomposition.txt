Так вот, начнется смотреть, что у нас будет дальше.
Ну, раз уж мы тут говорим о деревьях и каких-то там
декомпозициях, то очень хочется, конечно, тогда уж
нельзя не упомянуть, раз уж мимо идем, такую, ну
правда, конечно, известную многим олимпиадникам,
то есть, такую штуку, как Хавилай Декомпозицион.
Так, ну тут правда логичный соцопрос.
Во-первых, поднимите руки, кто знает, что такое Хавилай
Декомпозицион?
Кто слышал?
Ну, понятно, кто слышал такое понятие?
Кто слышал?
Да, поднимают руки все, потому что я его только что
сказал.
Да.
Да, как это хорошо, да.
Кто слышит нот, так, ну вот, примерно, да, третий
из вас, примерно, знает даже, что это такое, а кто его
хоть раз в жизни писал?
Так, чуть-чуть поменьше.
А кто его хоть раз в жизни написал успешно?
Ну да, ну такое бывает, я тут у себя в девятом, там
это, в девятом классе, там, в десятом классе давал,
ну вот, да, мне у всех получилось, да.
Нет, ну окей, формулировано, вот, в любом случае, да.
Ладно, пробовал писать, хорошо, вот так, нет, после
не у всех получается, там, а там серьезные люди, там
это, да, называется, там это, вроде, по ходу, это в этом
году тройно в серс поедут, приятно, вот, что, слово
в серс, ну из, ну и, ну из десятого класса, в котором
я там преподаю, вот, ну нормально, да, как-то, ну не очень успешно,
ну не очень успешно, из девятого класса поедут, видимо, пятеро,
ну вот, тоже верно, да, нет, ну, так, ну ладно, не буду
это говорить, вот, скажем так, ну, у меня есть на эту
тему кое-какие, ну, кое-какие инсайды, но на то они инсайды,
что, как бы, не публичная информация.
Ладно, значит, смотрите, значит, что такое heavy light decomposition,
значит, смотрите, это, то есть, ну, иногда бывает
такая ситуация, что, вот, когда у нас есть дерево,
на этот раз не обязательно подвешенное, да, то нам
очень хочется на нем делать те же операции, что и в каких-нибудь,
что и на массивах.
Ну вот, давайте себе, вот, для разминочки представим
такая ситуация, вот, для разминочки, может быть,
даже на уровне воспоминания, да, но дерево, ну, корневое,
не корневое, не важно, потому что любое не корневое
делается, да, делается корневым буквально вот этим вот методом,
вот, соответственно, да, так что-то у нас есть дерево,
и теперь, значит, и допустим, на каждой, ну, допустим,
на вершине написана чиселка, 6, 2, 4, там, 8, 1, 3, 2, там, 5, 6,
1, 2, там, от балды, 8, 7, 6, 5, 11, 2, 57, там, 8, 9, 2, 4, 6, вот,
а, нулик еще, вот, 5, 7, так, ну вот, ладно, не важно,
в данной задаче вообще не важно, нам очень хочется делать,
ну, решать какую-нибудь там, какую-нибудь задачу, обобщить
эту риску, ну, что, то есть, как она, то есть, обобщить ее
следующим образом, ну, мы, допустим, хотим, вот, давайте,
в более простом виде, там, ладно, не add, а, допустим,
assign в вершине v число x, то есть, я хочу взять вершину v
и сказать, что теперь там число x, а еще, ну, вот, я хочу
взять сумму на пути от u до v, вот, взять путь от u до v
и, собственно, рассмотреть его путь, просмотреть все чиселки
и найти сумму, вот, да, поэтому я и говорю, что это задача
на размитке, никакого отношения, никаких, боже упаси, там вас
писать, какие бы это ни были эти композиции в этой задаче,
вот, почему, потому что конкретно эта задача, как это часто
бывает, как это часто бывает, когда надо тут что-то суммами
делать, суммами или любыми другими кому-то ассоциативными
коммутативными обратимыми операциями, значит, делает это
так, перенумируем, значит, запустим dfs и перенумируем эти
вершины, перенумируем в порядке входа dfs в них, вот, я зеленым
маркером я пишу, ну, вот, жалко, что я свои эти 10 маркеров
не принес, а то было бы тут рыжая, вот, но ладно, вот, но
давайте так, ладно, тогда мы пойдем другим путем, я перенумирую
вершины буквами, даже вот так, a, b, c, d, e, f, g, h, i, g, k, l, n, n, o, p, q, r, s, t, q, v, w, x,
ничего. Где?
Как это? У нас же есть Excel. Все очень просто, не волнуйтесь.
Чиселки. Ой, Господи. Ну, в реальности мы будем их числами
все-таки записывать, да, в реальном ходе, но это неважно.
Важно другое, значит, ну, во-первых, начнем со следующего.
Начнем с того, что если вы хотите найти, значит, что такое путь?
Ну, как это всегда бывает в дереве, путь это когда вы берете вершину,
поднимаетесь из нее в какого-то предка, а потом из этого предка
спускаетесь к другой вершине. Вот, значит, то есть вот происходит
это вот примерно вот следующим образом, да, то есть вот, допустим,
если вот из этой вершины мы пытаемся дойти вот до этой вершины,
то мы вот поднимаемся до их LCA, а потом из этой LCA вот спускаемся
в другое место. Вот, да, теперь идея такая. Мы, что, если мы насчитываем
сумму, то мы можем насчитать сумму, для каждой вершины можно
насчитать и поддерживать сумму, значит, чисел от этой вершины
до корня. То есть вот так вот я напишу. Сум от V, то есть это вот, так сказать,
сум от, вот так вот скажем, root и V. Ну, для размера, вот я, это я
ввел определение. А теперь мистический факт. Я утверждаю, что сумму
на пути от, сумм от V можно посчитать теперь через только вот эти суммы.
Вот, то есть это равно. Не тривиально. Значит, сумм от U
плюс сумм от V минус два сумм от LCA от UV. Ой, ну плюс еще там вот эта
гадость. Не, там как бы теперь учтено вот сама LCA теперь учтено
ноль раз. Поэтому, поэтому как мы эту чиселку называли? Ну ладно, пусть так и
называется. C от LCA. Вот, то есть в принципе, если вы откуда-то из кармана
достанете LCA, а пока дерево не меняется, вы его можете достать за U от единицы,
то вы соответственно теперь можете вычислять эту вот сумму чисел вот таким
простым образом. Прям за вот единицы, обратите внимание. Правда, есть один
маленький момент. Если вы хотите поменять число, то у вас поменяется куча вот
этих вот суммов. Да, но теперь заметим, зачем мы перенумеровывали вершины. А
очень просто. Заметим, что теперь в этой нумерации под деревья, то есть
каждое под дерево любой вершины, это какой-то подотрезок с началом в ней
и окончанием в чем-то там. В чем-то там и это что-то там можно и предподсчитать
заранее. Поэтому по факту это присваивание, то есть если вы там число было 5, а вы
решили присвоить ему 12, то это означает, что просто на всем этом под деревья надо
прибавить 7. Зачем ленивое? Зачем ленивое? Обычное ДО. Присвоить, прибавить. Нет,
ленивое ДО это просто немножко другое. Да, ну да, то есть мы пишем дерево отрезков
с прибавлением на отрезки. Да, именно это мы и делаем. Ну, типа того, да. Ну, в
личном смысле скорее таки ассоциация. Вот, значит в результате, то есть получается,
что если у вас меняется один элемент и вот делаете вот эти вот суммы, то никаких
дополнительных композиций не надо, то есть если у вас в кармане лежит дерево
отрезков, то в общем-то этого вам достаточно. Ну, точнее так, это можно делать фенвиком
с прибавлением на отрезки, учитывая, что прибавление на отрезки сводится к задаче
без прибавления на отрезки, да, это мы помним. Да, но это, так вот, я вот к сожалению
запамятовал, возможно я это повторяю второй раз, потому что нет, фенвик с прибавлением
на отрезки, как бы это у нас точно было. Вы на это экзамен сдавали. В смысле?
Только один из вас сдавал экзамен? Нет, что-то это как? Это как-то...
Мы эту тему не проходили, что ли?
Так вот, ну хорошо, то есть пока у нас тут такая красота как сумма, это хорошо, но
к сожалению, как это часто бывает с суммой, если мы тут забабахаем хотя бы минимум,
то вот это вот, конечно, работать перестанет.
По крайней мере, вот такой вот простоты не будет, потому что у нас нету обратимости.
Ну вот, есть и, ну вот, ну и тем более, что иногда может очень захотеться делать
присваивание, то есть даже делать еще тоже такое усиленное присваивание,
присваивание на пути.
Так что вот такой вот нот, то есть вот такой вот мистический зуботребительный безобрази,
вот, значит, вот как же его делать?
Вот, но в этом нот, в этом нам поможет знаменитая heavy light decomposition,
то есть мы сейчас слово будем разбивать это дерево на пути, то есть мы сейчас разобьем
эти дерево на пути, кстати, могли бы в принципе longest pass decomposition делать,
если нас устраивает корень асимптотика корень из N, налог N.
Вот, то есть будем разбивать на пути, на каждом из этих путей мы будем строить,
ну, например, там дерево отрезков или каким вот образом мы умеем решать вот такую задачу,
можете хоть дикартьячку построить, вот.
И дикартьячку, сплей, там что-нибудь еще в этом роде, вот тут.
Катя вообще любит строить сплей и говорить, что лог квадрат превратился в лог.
Ну, это я опять забегаю вперед.
Вот, значит, мы это, собственно, будем разбивать на пути и, собственно,
на каждом пути, собственно, хранить там дерево отрезков и что-то вот с этим делать.
Вопрос только, как разбивать на пути.
Значит, определение.
Значит, ребро.
Значит, напишем так.
Ребро, допустим, parent от V запятая V, называется тяжелым.
Вот, тяжелое.
Если CZ от V, ну, допустим, больше либо равно, чем CZ от parent от V пополам.
О!
Вообще не округленное.
Или, что то же самое, округленное вверх.
Ну, вот.
А какая разница?
Ну, на самом деле так.
Чтобы достичь там нужной асимпточки, можно делать по-разному.
Можно делать так.
Ну, вот.
Ну, вот.
Ну, вот.
Ну, вот.
Ну, вот.
Ну, вот.
Ну, вот.
Ну, вот.
Что бы достичь там нужной асимпточки, можно делать по-разному.
Можно делать так.
Можно округлить любую сторону.
Можно вместо этого сказать там, что там объявим тяжелым ребром.
Там ребро, которое ведет в самое тяжелое под дерево.
Да, там.
Да.
Ой.
Выпадаю.
Нет, смотрите.
Сейчас.
Ну.
Ну, тут разные варианты есть.
Ну, вот.
Давайте.
Тут мышцы.
Мышцы.
Иначе.
Значит, мистическое утверждение.
Из каждой вершины.
Ну, вот.
Из каждой вершины торчит не более чем одно тяжелое
ребро.
Вау.
Вау.
Вау.
Вау.
Вау.
Вау.
Вау.
Тяжелое ребро.
Вау.
Вот такое красивое утверждение.
Ну, представь, что две.
Так.
И размер, как бы, под дерево немножко превысился.
Ну, да.
Но, тем не менее, утверждение не вернуло.
Вот.
Вот.
Вот.
Вот.
Вот.
Вот.
Вот.
Вот.
Вот.
Вот.
Вот.
Вот.
Вот.
Вот.
Вот.
Ну, вот утверждение.
Да.
Утверждается такое, что из вершины может торчать
более чем одно тяжелое ребро.
Да.
Да.
да ну это не хитрый прием просто когда из вершины торчит ребро помните что у нее
есть все-таки одно ребро вверх у него все-таки торчит то есть так можно сказать то есть скажем
так у каждой вершины в детей ведет действительно не более чем одного тяжелого ребра вот если
именно вот в детей то как бы да но идея вот и тут уже доказательство действительно очень
простое то есть жила была вершина и у нее есть размер там сз отв допустим у нее нашлось два тяжелых
ребенка вот тогда получается что тут у нас хотя бы сз отв пополам размер под дереве и тут хотя бы
сз отв пополам но тогда получается что уже в этих под деревьях количество вершин хотя бы
сз отв это невозможно почему потому что мы в этих вершинах учли не все вершины под дерево
вы почему не все но потому что саму-то вершину вы тоже должны были учесть отсюда и следует что
из каждой вершины вниз то есть потом в детей ведет не более чем одно тяжелое ребро вот такое
простое утверждение так утверждение понятно все да нет да пока да пока тут вроде ничего сложного
не но давайте разбираться так вот давайте попробуем кстати тяжелые ребра нарисовать
так так вот это ребро вот это не тогда менее показательно будет так тут 789
ну да нет я просто считал нету был бы с удовольствием я вообще люблю тяжелые красным цветом
не но нам сейчас вот эти буковки нам уже больше не нужны на самом так ну здесь все понятно здесь
все да вот здесь вообще удобно как бы да тупой способ да как это чтобы решить задачу давайте
рассмотрим простой способ когда граф например бабук и вот но мы понимаем вот кстати таки теперь
мы видим что эта задача действительно сложнее чем задача то же самое на массиве почему покину
потому что заведомо потому что на массиве это частный случай на дерево да то есть помните да то
есть массив это частный случай дерево такой да так ну здесь вот ну вот да я бамбук так
кошмар так а ну здесь получается вот так вот значит вот так вот такой путь а ну еще
вот тут вот ну да где нет развилок так а тут нормально так вот так вот и а и вот тут тупичок
во и конечно в этой декомпозиции бывают пути длины 1 но то есть обратите внимание что если оставить
от дерева только тяжелые ребра то не сложно убедиться что граф распадется на пути идущие
сверху вниз вот вот вот такая декомпозиция и называется хэйви лайт декомпозицию так это
и записывается хэйви лайт декомпозицию вот вот а типичный случай когда английский термин
дословно на русский переводится так себе вот тяжелолегкое тяжелолегкое разбиение что ли вот
значит смотрите что теперь нам предлагается делать если мы теперь очень хотим ну зелен вот если мы
теперь очень очень хотим с вами найти какой-нибудь вот что-нибудь на отрезке то и мы теперь должны
этот путь вот любой если нам нужно рассмотреть какой-то путь мы значит наем сериал каждое
ребро либо тяжелое либо легко и мы эти вот и если мы тут вот пишем вот эти легкие ребра вот как-то
так это будет наверное да легкие ребра могут и подряд идти кстати а все остальное это части зеленых
путей вот вы видите это вот да вот зеленая вот выглядит так вот путь начинается здесь идет там
куда-то вниз может быть здесь вот единственный случай когда обратите внимание у нас то есть у
нас нет не совсем не обязательно с корнем да но я вот имею ввиду следующее что смотрите то есть
вот все что если вы все что не легкие ребра это подотрески тяжелые подотрески вот этих тяжелых
путей причем эти подотрески нам это просто чуть позже будет важно они обладают таким маленьким
приятным свойством что только максимум один из них вот этот корневой может быть не префиксом
префиксом тяжелого пути то есть обратите внимание вот здесь тяжелый путь обязательно
начинается именно здесь потому что он куда-то вверх уйти не может потому что это дерево да нет
это это нам чуть позже будет важно ну придется ну что делать значит смотрите и теперь если мы на
каждом из этих деревьев делаем дерево отрезков то тогда время ответа на любой запрос это о от
логарифма n потому что мы за логарифмом работаем с деревом отрезков умножить на количество
лёгких ребер которые мы тут встретим вот приятная идея так нет так оно и есть потому что у нас все
вершины каждая вершина так или иначе к чему-то прикреплена поэтому да то есть как бы то есть
пути мы разбиваем на подотрески тяжелых путей может но так нет тогда тогда да вот тут тяжелый
путь может быть вот так вот выглядеть кстати да да такой тут и такое бывает
типа того да или нет на прессе длины 1 если быть точнее до каждом из зеленых путей да на каждом
из зеленых путей мы строим дерево отрезков нет там дальше могут быть разные технологии там разные
советы то есть там можно перенумеровать вершины таким образом чтобы можно было построить одно
дерево отрезков на всех ну пошли можно перенумерать так чтобы каждый путь это был подотрезок то есть
типа там 0 1 2 3 вот это вот ну вот да да правда дальше начинается там это обсуждение но код
форси в котором говорят что нет на самом деле нужно на каждом из этих деревьев значит строить
свое дерево отрезков и более того все запросы желательно делать по возможности снизу потому
что тогда ассептотика будет быстрее якобы да я не понял почему я вообще не понял почему но там
вот древние обсуждения но вот тем более того там в каве более более того там в комментариях по
сту вроде там-то люди типа там капеллевичей курнявского даже не приводили пример просто
пример на котором это реально работает за вот слог квадрат который у нас тут возникает вот
а тут возникает по камере если вот по камере железобетонно тут возникает именно лог квадрат
потому что я утверждаю что если вы идете от вершины куда-то вверх то на пути от нее до корня вы встретите
не более чем логарифом легких легких тяжелых сколько угодно потому что да потому что если
есть у вас граф это бамбу ча то как бы у вас все ребра тяжелые вот помните бамбу чить такой
дерево у которого все ребра бобов нот все ребра тяжелые а кстати это может быть определение
бамбука такой граф у которого все ребра тяжелые а легко доказать потому что если если хоть у
какой-то вершины есть более одного ребенка значит хотя бы одно из этих ребер легкое все вот
да так же такой вот прикол да как это называется как называется граф в котором нет легких бамбу
так красота вот значит и так значит смотрите но теперь скажет вас почему их не более чем логариф
да ну да идея да простая что чьи-то когда вы идете снизу вверх от вершины до корня то когда
вы проходите по тяжелому ребро размер под дерево увеличивается нет увеличивать а когда он проходит
по легким ребрам он увеличивается хотя бы в два раза нет нам это очень важно потому что если
вон там увеличился в два раза потом на тяжелом ребре уменьшился обратно то как бы ничего бы не
доказали поэтому или так пожалуйста на вашу да да да да как бы слева направо
справа налево суть одна вот значит смотрите ну вот то есть действительно то
есть легких ребер у нас тогда получается удваиваться мы можем не
более чем там логарифм раз поэтому получается логан но фактически то есть
пусть разбивается тут на 2 логарифма отсюда на aparece а симпonsciousка о нормально
и тогда у нас получается асимп信 Woo от логари лог квадратagi если вот как
всегда вот получается вот то есть все то есть путial то для fearless
мы с деревом можем делать практически все то же самое что мы могли делать залог
с деревом отрезков или декартовым деревом или с плей деревом или любым другим деревом
называется ну потому что у нас тут все красиво, правда, не более чем логарифм
ну плюс, ну да, логарифм плюс 1. Нет, почти как-то наоборот, уже как, потому что
на каждом тяжелом пути мы забабахали просто тупо дерево отрезков, поэтому
каждый раз когда приходит какой-нибудь путь и мы хотим делать вот такой ассайн,
мы рассматриваем этот путь, смотрим где у него легкие ребра, где
тяжелые, ну там как-то разбиваем, но даже не как-то, а просто в любой декомпозиции
мы там, например, по вершине можем легко понять, собственно, где она находится,
правда, то есть, вообще, где она находится и на каком тяжелом пути она находится и
насколько высоко он идет, вот, и тогда, значит, на этом подотреске мы выполняем
присваивание на подотреске в дереве отрезков.
А если у нас путь идет выше, чем для ЛЦА? Ну тогда, значит, мы в этом месте, идя от этой
вершины до сюда, останавливаемся и присваиваем только на этом подотреске.
Как мы ЛЦА узнаем? ЛЦА, вот тут интересный момент,
во-первых, самое тупое, что можно сделать это, собственно, отдельно посчитать ЛЦА, но этого
не нужно делать, а нужно делать следующее, потому что, как вы помните, мы, вот что мы точно умеем
делать легко за О от Н, это насчитать таймы на и тайм-ауты, и это позволяет нам за О от единицы
понимать про каждую вершину, ну там что-то в духе, там про каждые две вершины является ли одна из
них предком другой, помните? Да, вот это вот, это у нас точно было, это делается за О от единицы,
вообще вот, без какой бы то ни было магии, почти, вот, а теперь идея такая, если вы это насчитали,
то, ну, идея такая, то есть присвоить надо вот на этой части пути и на этой части пути, видите, да?
Значит, идея теперь возникает следующая, теперь не насчитываем никаких ЛЦА, вы просто идёте,
говорите, так вот, берём вот эту вершину, так, где у неё путь начинается вот в этой вершине? Так,
эта вершина является предком этой вершины? Не является, ну отлично, eldest песваевым, идем
к родителю, так, теперь, у неё путь начинается вот здесь, так, этой вершины является предком этой
вершины? Ой, не является, присваиваем, идем дальше, так, берём эту вершину, берём, так, где у
неё путь начинается, так, эта вершины является предком этой вершины? Ой, является, тогда,
town. Да? Подождем. Потому что давайте теперь проделаем то же самое,
только вот с этой вершины. Значит идём теперь, значит нуこれ делаем,
присваиваем тут, присваиваем тут, присваиваем… Прости, господи, вот тут.
Ну а теперь интересно, присваиваем тут и тут мы натыкаемся вот
на вот эту вершину. У которой тоже вот сначала пути является предком,
уже вот этой вершины.
Но тогда теперь уже, как легко убедиться уже из картинки, то есть те вершины две, которые вы наткнулись, они лежат на одном и том же пути.
Который просто в том же пути, который идет выше.
Поэтому, ну вот тогда вам остается только на этом подотреске найти, сделать присваивание и все.
Кстати, в качестве бесплатного приложения вы еще ИЛЦА нашли.
Специально писать отдельный код, тратить время и писать код отдельно ради ИЛЦА вам здесь не нужно.
Вот это очень удобно.
То есть это вот такой технический момент по реализации.
Ну вот так.
Так, 15 минут у нас, да?
Ну как сказать, а вы знаете, что я сейчас хочу рассказать?
Вот, представляете.
Так, ну ладно, по вот этой штуке пока вопроса есть.
Окей, ну вот.
Так, ну вот.
Ну по реализации тут сейчас будет боль, значит, смотрите.
Потому что, как бы, единственное, нам не нравится квадрат.
Но теперь за оставшиеся 15 минут я попробую предложить, как это делать за логарифом.
Не потеряв задачу, которую мы хотим решать вообще?
Вообще.
Ну я продолжаю утверждать, что как бы все, что вы могли тут делать с деревом отрезков или дикартовым деревом.
Там или овлкой.
Ну мы помним, да, овлкой как дикартячка, только без вероятностей.
В смысле умеет то же самое абсолютно.
Но помните, да, там сплит.
На экзамене никого не спрашивали там.
Ну да, нет.
Господи да.
А как такое могло произойти?
Чего-чего?
Ну не знаю.
Вероятность, магия, Господь Бог на защитил, понимаешь?
Я не знаю.
Ну может.
Да, он так расстроился, что больше не пришел.
Ну хотя нет, сплитверш ВВЛ на самом деле не такая сложная вещь.
Ну, как сказать, почему она считает, почему я могу считать не сложной вещью?
Потому что я на каком-то там этмошном видеокурсе реально, по-моему, видел там, собственно, ее объяснение.
Вообще-то там как-то не очень сложно оказывалось даже.
То есть в чем они там, по-моему, даже никаких отсылок в Б дереву не делали в отличие от нас.
Вот, ну не важно, значит, смотрите.
Так, ну вот для этого вот тут Тихон спрашивал, что у нас тут проходили магистральные темы и тут забыли какую-то мелочь.
Значит, часто это какие-то мелочи.
Вот сейчас одну из этих мелочей мы сейчас должны будем осветить чуть более подробно.
Значит, смотрите, какая ситуация.
Вот сейчас вот этот логарифм мы сейчас победим за счет следующей, за счет того, что вот мы сейчас будем жестко пользоваться тем, что здесь все запросы практически, кроме может быть одного, это префиксы.
Последовательно идущие, понимаете, да?
А теперь давайте внимательно посмотрим, как будет выполняться присваивание или поиск что-нибудь на отрезке, если этот отрезок префикс.
Как это может быть?
Как это будет скорее всего выполняться?
Ну да.
Ну или, а сейчас начнем для разминочки с деревоотресков.
Вот для разминочки, кстати, тоже будет полезно.
Я рассмотрю такую задачу.
Дан массив.
Массив состоит из ноликов и единичек.
Я хочу делать два запроса.
Заменить какой-нибудь элемент, номер поз.
Ну там, нолик на единичку, единичка на нолик.
И найти катую единичку.
Ну, легче катую единичку.
Господи, фенвики?
Это ну, ну как сказать, как известно, если объединить.
Если объединить, как это?
Ну помните, мы же по-моему рисовали эту картинку.
Если объединить это обычного фенвика и встречного фенвика, то получится просто деревоотреска в чистом виде.
Вот мы, собственно, не будем от этого оригинала ходить.
И давайте, как мы будем решать эту задачу?
Мы построим залогарифум, а не залог квадрат.
То есть мы не хотим бинпольск.
И нам он не нужен.
Ну, изменять элемент понятно.
Один элемент залогарифом легко меняется.
А, ну деревоотресков мы строим на сумму.
То есть там в каждом подотреске мы храним сколько там единичек.
Тогда дальше идея такая.
Мы делаем, значит, залогарифом ищем катый элемент следующим образом.
Мы идем в левое под дерево корня и спрашиваем, а катая единичка случайно не у вас?
Как он это узнает?
Да очень просто.
Так, у меня сумма больше либо равно k или нет?
А у меня равно k, значит, эту единичку надо искать где-то здесь.
И тогда если это так, то мы просто за о от единицы спускаемся сюда и ищем там катый элемент.
Но если мы катый элемент оказывается здесь, то есть вот тут оказалось всего пять единичек,
а мы ищем какую-нибудь там опять двенадцатую,
то значит нам надо просто найти седьмую единичку вот в этом под дереве, правда?
То есть за о от единицы мы поняли, куда надо спускаться влево или вправо.
Аналогичным образом мы спускаемся уже здесь, потом здесь, ну и так далее.
То есть это вот аккуратный спуск по дереву отрезков.
Далее.
Более того, заметим, что практически все операции будут по сути делать ровно то же самое.
То есть если я захочу тут присваивать, например, на подотресках, да?
То есть присваивать на префикс я захочу, да?
То как это будет выглядеть?
А очень просто.
Я могу делать это ровно тем же методом.
То есть просто я говорю, либо надо ли мне,
если мне надо полностью покрыть вот эту левую половину,
значит я ее за о от единицы присваиваю,
ну помните технологию отложенных операций, да?
И иду покрывать префикс справа.
Ну вот, если мне не нужно все, значит я всю левую половину покрывать,
значит я иду просто рекурсивно влево.
Ну не рекурсивно, а даже вайликом по сути иду.
Нет, пока, ну да.
Пока логарифом.
Но заметим, что ровно тем же самым образом
каты-элемент в каком-нибудь явном дикартовом дереве тоже ищутся, помните?
И более того, присваивание или там что-нибудь еще
на дикартовом дереве тоже делается ровно так же, правда?
То есть если вы хотите, то есть у вас присвоить на префиксе,
то у вас дикартовом дереве тоже самое, думайте.
Вот на этой вершине надо присваивать?
Если не надо, значит вы просто идете в левое под дерево и живете там.
А если надо, то вы идете в это левое под дерево,
присваиваете прямо на всем дереве зоот единицы,
и дальше присваиваете на каком-то префиксе правого под деревом.
И это делается вот абсолютно тем же самым спуском.
Понимаете, да? Пока все просто.
Нет, я просто к чему.
То есть это все делается за логарифом вот таким красивым спуском.
Так вот, сейчас, чтобы достичь вместо логарифа квадрат логарифа,
мы просто на этих путях построим такое специально,
очень специального вида двоичное дерево.
То есть это тоже будет такое дерево по неявному ключу,
но это будет не дикартовое дерево, это будет не сплей дерево,
это будет принципиально новое дерево.
Но оно будет обладать двумя свойствами.
Во-первых, высота у него будет логарифом N.
Да, сразу обращу внимание, что интересно,
у него высота будет именно логарифом N, но не логарифом длины пути.
Обратите внимание, да?
Именно логарифом N, чуть пожирнее.
Но при этом мы будем гарантировать, что если к таким деревьям
обращаться именно как к префиксам, то есть оно будет построено так,
что суммарно на вот таком наборе префиксов,
последовательно идущих сверху вниз, будет работать за логарифом.
Нет, оно будет не за O от единицы, там более хитрая амортизация будет.
Там не будет O от единицы, то есть каждый конкретный запрос за логарифом,
но суммарно они будут за логарифом.
Значит, смотрите магию.
Ну, не очень сложная, но это, конечно, магия.
Значит, смотрите.
Рассмотрим вот такой вот красивый тяжелый путь.
Вот я его даже вот так, я его слегка даже наклоню.
Вот он.
На, ну вот, на, ну там вот сверху еще что-то может быть есть,
и на каждой из этих вершин тут на легких ребрах висят какие-то под деревья.
Вот так вот.
Значит, смотрите, то есть я введу теперь у каждой вершины такое понятие как ранг.
Вот если эти вершины обозначить как, вот зеленые вершины обозначить как V1, V2, V3, V4, V5 и так далее.
Ладно, пусть будет V7.
То я скажу, что ранг ВИТОВА это будет СЗ от ВИТОВА минус СЗ от ВИПЛЮСПЕКОВ.
То есть в переводе говоря я хочу сказать, сколько всего на вершине лежит,
сколько всего висит на вершине, если отпилить от нее вот этого тяжелого ребенка.
Да, то есть СЗ вот, то есть ну просто СЗ от нее, это на самом деле оно содержит вот это вот все.
Ну не левое под дерево, там несколько до самом деле под деревом.
Да, она же не бинарная дерево.
Да, не бинарная. Вот, а это ребро вот, ну вот. То есть просто отпилить вот, то есть если мы от нее отпилим вот его тяжелого ребенка,
что останется? Саму ее мы считаем, напоминаю, то есть очень важно, что СЗ как минимум один и не более чем N.
Вот, приятно, да?
Да, ну заметим, что СЗ от, то есть ранг, ну тут мы не заморачиваемся, вот от последней вершины тут все просто.
РК от вот В, вот этой вот последней, оно просто будет равно СЗ от В7, потому что у нее тяжелых детей нет.
Видите, да?
Вот, ну почему бедный? Ну вот, ну жалко как-то.
Ну хотя, хотя чего, хотя чего, может наоборот у нее на самом деле, наоборот, очень много легких детей, она счастлива и вот все хорошо.
Вот, соответственно.
Да.
Ну как сказать, как это, ну как это действительно нет?
Ну да, как-то дети это в принципе прекрасно, а вот особенно когда они не тяжелые.
Логично, правда?
И вообще мы живем в хорошем мире, когда у вас количество тяжелых детей не более чем один.
Вот.
Ладно, так вот.
Так что к чему я это все?
Так что прямо сейчас я построю на этой, на этом массиве вершин двоич, неявное такое двоичное дерево.
Но корень я у него буду вычислять весьма экзотическим образом.
Значит, смотрите, вот у них есть ранги, да?
И этот ранг, и сумма этих рангов не превосходит n.
Вот давайте пусть я напишу, что s это вот там ранг от v и t, в общем сумма по i равно от одного, ну в нашем случае 7, да?
Так вот, я утверждаю, что я могу выбрать вершину какую-то таким образом, чтобы у нее слева от нее, строго слева от нее суммарно ранг был не более чем s пополам, и справа от нее суммарный ранг был не более чем s пополам.
Вот я утверждаю, что такая вершина найдется.
Может быть даже две.
У нас состоит одна.
Ну да.
Но там оба раза строго меньше не получится.
Но убедиться в этом очень, значит, найти ее очень просто.
Потому что, смотрите, давайте идти, идти и насчитывать сумму рангов.
И давайте вот остановимся в том месте, где у нас впервые сумма стала больше либо равна, чем половина.
Почти, да.
Да, тогда заметим, что слева сумма меньше была.
Рангов.
Размер поддерева без учета тяжелого поддерева.
Вот.
То есть вот чтобы тут в этих синих висело не более чем s пополам, и тут висело не более чем s пополам, да?
Вот.
Размер поддерева без учета тяжелого поддерева.
Вот.
То есть вот чтобы тут в этих синих висело не более чем s пополам, и тут висело не более чем s пополам, да?
То есть тогда тут висит меньше чем s пополам, потому что это первая вершина, чтобы тут сумма больше либо равна.
Но так как тут больше либо равно с другой стороны, то тогда здесь меньше либо равное с пополам.
Ура.
За линию нашли.
А теперь идея такая.
Ну отлично.
Давайте объявим теперь это корнем.
А вот на этих подотресках построим все рекурсивно.
Так я не понимаю, почему у вас ХЛД возникла центроидная декомпозиция.
Нет, это не центроидная декомпозиция, это что-то похожее.
Ура.
Да, причем нет, это взвешенная центроидная декомпозиция.
Это вообще вот еще круче.
Ну ладно, погодите, давайте без центроидной пока декомпозиции.
Вот.
Тем более что я пока не знаю, придет таких интересных фактов, кроме того, что она есть и она веселая.
Вот.
Значит смотрите, на этих подотресках соответственно, понятно, левое и правое под дерево вы построите уже, ну, аналогичным образом, понятно, да?
Ну заметим, что так как у нас ранг не превосходит n, то тогда глубина такого дерева будет заведома не более чем логарифом n.
Ну понятно, что если брать по количеству вот этих вот самих зеленых вершин, естественно, ни о какой сбалансированности речи быть не идет.
То есть более того, там вполне может выясниться, что на самом деле это вот построенное дерево, оно на самом деле будет тоже вполне себе бамбуком, если вот будет выясняться, что тут на этой вершине много висит, на этой в два раза меньше, на этой в четыре и так далее.
Да, но гарантируется, но глубина дерева точно не более чем логарифом n.
Понимаете, да?
То есть глубина логарифа, то есть получается, каждый из этих запросов, то есть на этом дереве тоже можно, как в дереве отрезков и дикартовом дереве, делать всякие эти присваивания на отрезке, искать сумму на отрезке, это будет за логарифом.
Вот, понятно, да?
Ну то есть там глубина не больше чем логарифом, просто у нас количества не больше.
Да, но правда единственное, поэтому я обращал внимание, что там логарифом именно n, то есть всего дерева, а не логарифом количества вершин на самом пути.
То есть понятно, что у нас тут сумма рангов интересует.
А вот теперь начинается самое интересное.
Теперь я утверждаю, что если вы будете работать с этими деревьями, и еще в качестве добивки этот путь вы будете ориентировать так, что он идет сверху вниз,
хотя ладно, снизу вверх тоже самое, то тогда я утверждаю, что у вас тогда эти все запросы суммарно будут работать за логарифом.
Ну на самом деле понятно, что каждый запрос работает за логарифом, вот этот запрос мы из рассмотрения выкинем.
Он за логарифом работает, потому что на самом дереве все понятно.
То есть нас по сути сейчас интересует следующее.
Вот, смотрите, сейчас будет следующее.
То есть предположим, что у нас есть путь, вот рассмотрим какой-то путь вот сверху вниз.
И на нем мы рассмотрим, и он разбился на вот такую последовательность префиксов тяжелых путей.
Вот так вот. Пум-пум, там пум-пум, пум-пум. Видите, да?
А теперь идея такая. Вот мы находимся, допустим, вот давайте себе скажем вот что.
То есть мы сейчас находимся вот в этой вершине.
Значит, мы сейчас будем говорить, что у нас в некотором смысле на этой вершине висит вот огромное количество вершин.
То есть все вот это под дерево, да?
Ну это не в некотором смысле, это же действительно.
Да, ну так и есть.
Ну ладно, не важно. Вот, тут вот какие-то под деревья, тут вот все это висит.
Все тут везде висит. Ну вот, и теперь смотрите.
А теперь идея такая. Значит, давайте мысленно проводить следующую операцию.
Начнем сверху. Вот будем представим себе, что мы с этими путями работаем сверху вниз.
Ну понятно, пристановке мест лагаем, сумма не меняется, да?
То есть реализационно ничего не поменяется.
Ну вот. Значит, теперь идея такая.
Как мы будем работать?
Значит, как мы будем работать с этим деревом?
Мы найдем этот вот, так сказать, центроид.
Вот он, центроид, да?
И тогда идея такая. Если этот центроид оказался не на пути, то значит с этим вот, с правым под деревом и этой вершиной ничего делать не надо, надо приходить в левое под дерево, да?
Вот зелененькие.
И мы с этим вот зеленым путем сейчас работаем.
Тогда смотрите.
Вот если вот первый центроид у него оказался не на этом вот длинном пути, на котором мы пытаемся найти ответ.
Вот у нас есть длинный путь, есть ответвление, да?
То тогда, то тогда теперь идея такая.
А давайте-ка вот все вот это вот, все эти вершины, вот эту вершину ее под дерево просто вот отпилим.
Ну мысленно отпилим, мысленно.
Заметим, что количество, то есть как бы было у нас под дерево, теперь у нас под дерево минус вот это под дерево.
Но я утверждаю, что все эти вершины умерли.
Так вот я утверждаю, что мы отпилили хотя бы половину.
Потому что у нас все, все вершины на самом деле, они участвовали вот в этих под деревом.
Ну мы отпилили хотя бы половину.
Потому что у нас все, все вершины на самом деле, они участвовали вот в этих рангах.
И мы сейчас отпилили целое правое под дерево и один корень.
То есть как минимум половину отпилили, вот мы это так определяли, помните?
Нету, один большой путь, от которого что-то ответвляется.
Потому что одно дело путь, на котором вы что-то ищете, вот он путь, да?
А другое дело, что от этого пути вот тяжелый путь реально может ответвиться в какой-то момент.
Ответвиться-то можно, но он не пойдет дальше вниз.
Пойдет. Вниз пойдет, просто не туда вниз.
Да, но просто, но мы пока все равно эти все вершины рассматривали.
Но как бы если тут центроид этого пути оказался не на интересном пути,
то мы значит это под дерево отпилили и количество рассматриваемого путьа,
то мы значит это под дерево отпилили и количество рассматриваемых вершин уменьшилось не более чем в два раза.
Не менее чем в два раза.
Вот все рассматриваемых вершин.
Мы говорим, что у нас есть множество рассматриваемых вершин.
По сути я говорю так, меня сейчас интересует только, то есть смотрите,
когда я тут вот спускаюсь по вот этому дереву, да, у меня в каждый момент времени я работаю вот с каким-то подотреском этих вершин.
И на этом подотреске висят какие-то вершины.
Вот я говорю, что они мне интересны. Мне интересно, как это количество уменьшается.
Тогда вот когда мы выкинули этот подотресок и корень, то значит мы тут вот выкинули какое-то число вершин и суммарное число их уменьшилось хотя бы в два раза.
Но теперь заметим, что если центроид оказался с этой стороны, да, то здесь тоже оказался, то тогда мы отпиливаем вот все, что вот это висит.
Ну мы тоже за О от единицы как бы тут выполнили операцию, буквально за О от единицы, да, и убили вот целое тут вот все, что тут висело, вот это тоже убили.
То есть каждый, то есть получается каждый шаг вот этот вот спуск в этом дереве, он получается убивает нам хотя бы половину вершин.
Причем смотрите, как интересно происходит. В какой-то момент кончится в итоге тем, что рано или поздно центроидом окажется вот эта сама вот эта вершина, да.
Тогда мы соответственно понятно убьем и вот это и вот это, и на ней останется висеть только вот то, что висит вот на этом пути.
Логично, да? Вот.
И тогда, но теперь мы переходим к следующему пути.
Но когда перейдя к следующему пути, мы получаем еще одну вершину убили.
И рассматриваем теперь только то, что висит конкретно на этой вершине.
Видите, заметьте, вот это-то оно же как бы все же жило, оно же как было интересными вершинами, так и остается.
Но теперь, когда мы будем делать эти спуски на дереве здесь, то тоже каждый спуск будет нам убивать хотя бы половину из тех вершин, которые вышли.
То есть смотрите, то есть у нас есть, то есть получается каждый спуск по дереву, там, к ребенку, он нам убивает количество интересных вершин хотя бы в два раза.
И тогда из этого следует, что спусков по дереву, то есть шагов вот этого спуска по дереву у нас не более чем суммарно логарифм n.
Так что на самом деле, то есть, скажем, по крайней мере в тех операциях, которые вы, если вы там просто делаете какие-то операции с деревом отрезков, то и на дереве вы можете их делать за логарифмическое время.
Вот. Ну там на самом деле могут быть, конечно, задачи там всякие, там на Heavy Light, в котором приходит, в котором так не работает.
Там иногда бывает, что в Heavy Light приходится на самом деле эти элементы хранить в сети и с ними что-то делать, там разные варианты есть.
Это уже задача. Но тем не менее, по крайней мере, но по крайней мере на сегодня, по крайней мере, мы убедились, что оказывается дерево отрезков может прекрасно обобщиться на дерево.
Ну вот на дерево вот таким вот красивым способом.
Так. Ну вот. Ну собственно вот. А у вас, конечно, следующая пара начинается.
Так что вот. Ну а тогда на сегодня все. В следующий раз тогда будем говорить снова о целочисленных структурах данных.
